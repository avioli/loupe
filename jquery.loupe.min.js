// (c) 2010 jdbartlett, MIT license
(function(a){a.fn.loupe=function(b){var c=a.extend({loupe:"loupe",width:200,height:150},b||{});return this.length?this.each(function(){var j=a(this),l,i,f=j.is("img")?j:j.find("img:first"),k=j.siblings(".trigger"),h=j.parent("a"),e,g=function(){i.hide()},d;if(!k.length){k=j}if(j.data("loupe")!=null){return j.data("loupe",b)}fakeclick=function(o,n){if(!n){return}while(n.nodeType!=1){n=n.parentNode}var m=document.createEvent("MouseEvents");m.initMouseEvent("click",true,true,o.view,1,n.screenX,n.screenY,n.clientX,n.clientY,o.ctrlKey,o.altKey,o.shiftKey,o.metaKey,0,null);m.__fakeClick__=true;n.dispatchEvent(m)};e=function(q){var p=f.offset(),r=f.outerWidth(),n=f.outerHeight(),m=c.width/2,o=c.height/2;if(!j.data("loupe")||q.pageX>r+p.left+10||q.pageX<p.left-10||q.pageY>n+p.top+10||q.pageY<p.top-10){return g()}d=d?clearTimeout(d):0;i.show().css({left:q.pageX-m,top:q.pageY-o});l.css({left:-(((q.pageX-p.left)/r)*l.width()-m)|0,top:-(((q.pageY-p.top)/n)*l.height()-o)|0})};i=a("<div />").addClass(c.loupe).css({width:c.width,height:c.height,position:"absolute",overflow:"hidden"}).append(l=a("<img />").attr("src",j.attr(j.is("img")?"src":"href")).css("position","absolute")).mousemove(e).click(function(m){if(h.length){fakeclick(m,h.get(0))}}).hide().appendTo("body");j.data("loupe",true);k.data("loupe",true).mouseenter(e).mouseout(function(){d=setTimeout(g,10)})}):this}}(jQuery));